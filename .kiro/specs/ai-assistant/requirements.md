# Requirements Document: AI Assistant Integration (Phase 6)

## Introduction

The AI Assistant Integration feature is Phase 6 of Grin's Irrigation Platform, building on the foundation established in Phases 1-5 (Customer Management, Field Operations, Scheduling, Route Optimization, and Map Interface). This phase integrates an AI assistant powered by Pydantic AI directly into the operations platform to automate Viktor's most time-consuming manual tasks, potentially saving 15-20 hours per week during peak season.

The AI assistant follows a strict human-in-the-loop principle: AI NEVER executes actions without explicit user approval. The flow is always: AI Analyzes → AI Recommends → User Reviews → User Approves → System Executes.

## Glossary

- **System**: The Grin's Irrigation Platform backend API
- **AI_Agent**: The Pydantic AI-powered assistant that analyzes data and generates recommendations
- **AI_Tool**: A function callable by the AI agent to retrieve data or perform calculations
- **AI_Context**: Business data provided to the AI for decision-making (customers, jobs, services, staff)
- **AI_Recommendation**: A suggested action generated by the AI requiring user approval
- **Confidence_Score**: Internal metric (0-100%) indicating AI certainty in a recommendation
- **Confidence_Threshold**: The 85% cutoff for routing to "Ready to Schedule" vs "Needs Review"
- **Communication_Draft**: AI-generated message text requiring user approval before sending
- **Communication_Queue**: Centralized list of pending, scheduled, and sent communications
- **Morning_Briefing**: Daily summary panel showing overnight requests, schedule, and pending actions
- **Schedule_Proposal**: AI-generated optimized weekly schedule for user review
- **Job_Categorization**: Classification of jobs as "ready_to_schedule" or "requires_estimate"
- **Estimate_Calculation**: AI-generated pricing based on job type, zones, and similar completed jobs
- **Business_Query**: Natural language question about customers, jobs, revenue, or operations
- **Rate_Limit**: Maximum 100 AI requests per user per day to control costs
- **Context_Window**: Maximum 4000 tokens of business data provided to AI per request
- **Session_History**: Chat messages stored only for browser tab lifetime (max 50 messages)
- **Audit_Log**: Record of AI recommendations and user decisions for compliance
- **PII_Placeholder**: Identifier used in AI prompts instead of actual personal information
- **Weather_Flag**: Warning when precipitation probability exceeds 70% for scheduled jobs
- **SMS_Provider**: Twilio service for sending and receiving customer text messages
- **Twilio_Webhook**: Endpoint receiving customer SMS replies for confirmation tracking

## Requirements

### Requirement 1: AI Agent Foundation

**User Story:** As a system administrator, I want a robust AI agent infrastructure, so that all AI features have a consistent, secure, and cost-controlled foundation.

#### Acceptance Criteria

1. WHEN the system initializes, THE AI_Agent SHALL configure with OpenAI GPT-5-nano as the default LLM provider
2. WHEN the AI_Agent is configured, THE System SHALL support provider abstraction for future swap to other models (GPT-4, Anthropic Claude)
3. WHEN the AI_Agent processes a request, THE System SHALL enforce a maximum context window of 4000 input tokens
4. WHEN context exceeds 4000 tokens, THE System SHALL truncate oldest data while preserving current request and business rules
5. WHEN the AI_Agent generates a response, THE System SHALL support streaming output for real-time display
6. WHEN any AI request is made, THE System SHALL never send PII (names, phones, emails, addresses) to the LLM API
7. WHEN generating responses with customer data, THE AI_Agent SHALL use placeholders (e.g., "Customer #1234") that are filled locally
8. WHEN the AI_Agent encounters an error, THE System SHALL gracefully degrade to manual workflow with "AI temporarily unavailable" message
9. WHEN the LLM API returns invalid output, THE System SHALL retry once, then show "AI couldn't process this" message
10. WHEN network timeout occurs, THE System SHALL retry with exponential backoff (max 3 attempts) before showing error
11. THE System SHALL log all AI operations using structured logging with domain namespace "ai"
12. THE System SHALL track AI request timestamps, token usage, and estimated costs in usage metrics

### Requirement 2: Rate Limiting and Cost Control

**User Story:** As a business owner, I want AI usage limits and cost monitoring, so that I can prevent runaway LLM costs while maintaining service availability.

#### Acceptance Criteria

1. WHEN a user makes AI requests, THE System SHALL enforce a limit of 100 requests per user per day
2. WHEN the daily limit is reached, THE System SHALL display "Daily limit reached, resets at midnight" and enable manual workflows
3. WHEN a single request exceeds token budget, THE System SHALL enforce 4000 input + 2000 output token limits
4. WHEN token budget is exceeded, THE System SHALL truncate context and warn user
5. WHEN monthly AI costs reach $50, THE System SHALL send an email alert to the administrator
6. WHEN monthly AI costs reach $100, THE System SHALL optionally disable AI features (configurable)
7. THE System SHALL track per-user daily request counts with automatic midnight reset
8. THE System SHALL track total tokens used and estimated cost in USD per request
9. THE System SHALL provide an admin endpoint to view current usage statistics
10. WHEN rate limited, THE System SHALL ensure all manual workflows remain fully functional

### Requirement 3: AI Audit Trail

**User Story:** As a business owner, I want a complete audit trail of AI recommendations and decisions, so that I can review AI accuracy and maintain compliance.

#### Acceptance Criteria

1. WHEN the AI_Agent generates a recommendation, THE System SHALL log the action type, entity type, entity ID, and timestamp
2. WHEN a user approves an AI recommendation, THE System SHALL log the user decision as "approved" with timestamp
3. WHEN a user rejects an AI recommendation, THE System SHALL log the user decision as "rejected" with timestamp
4. WHEN a user modifies an AI recommendation, THE System SHALL log the user decision as "modified" with timestamp
5. THE System SHALL store AI recommendation summaries in JSONB format (not full prompts for cost/privacy)
6. THE System SHALL NOT log raw LLM responses or full prompts to protect privacy
7. THE System SHALL provide an endpoint to query audit logs by date range, action type, or entity
8. THE System SHALL retain audit logs for a minimum of 90 days

### Requirement 4: Intelligent Batch Scheduling Assistant

**User Story:** As a business owner, I want the AI to generate optimized weekly schedules, so that I can reduce the 8-10 hours per week spent on manual scheduling to 30 minutes.

#### Acceptance Criteria

1. WHEN a user requests schedule generation, THE AI_Agent SHALL analyze all jobs with status "ready_to_schedule"
2. WHEN generating a schedule, THE AI_Agent SHALL batch jobs by location (city) to minimize drive time
3. WHEN generating a schedule, THE AI_Agent SHALL batch jobs by type (seasonal together, repairs together, installs together)
4. WHEN generating a schedule, THE AI_Agent SHALL calculate time estimates based on zone count and system type
5. WHEN generating a schedule, THE AI_Agent SHALL match job requirements to staff skills and availability
6. WHEN generating a schedule, THE AI_Agent SHALL flag jobs requiring specific equipment (compressor, pipe puller)
7. WHEN generating a schedule, THE AI_Agent SHALL apply first-come-first-serve with 2-4 day buffer for route optimization
8. WHEN generating a schedule, THE AI_Agent SHALL flag weather-sensitive jobs on days with >70% precipitation probability
9. WHEN generating a schedule, THE AI_Agent SHALL apply staffing rules (1 person for service, 2 for major repairs, 2-4 for installs)
10. WHEN a schedule is generated, THE System SHALL display proposed schedule with staff assignments, time estimates, and route miles
11. WHEN a schedule is generated, THE System SHALL display warnings for conflicts, equipment needs, and weather concerns
12. WHEN a schedule is generated, THE System SHALL provide "Accept Schedule", "Modify", and "Regenerate" actions
13. WHEN a user accepts a schedule, THE System SHALL create appointments only after explicit approval
14. THE AI_Agent SHALL provide an explanation of scheduling decisions and optimization rationale

### Requirement 5: Automated Job Request Categorization

**User Story:** As a business owner, I want incoming job requests automatically categorized, so that I can quickly identify which jobs need attention and which can be scheduled immediately.

#### Acceptance Criteria

1. WHEN a job request is received, THE AI_Agent SHALL analyze the request description using NLP
2. WHEN analyzing a request, THE AI_Agent SHALL match against the service catalog for automatic pricing
3. WHEN analyzing a request, THE AI_Agent SHALL identify existing vs new customers
4. WHEN analyzing a request, THE AI_Agent SHALL cross-reference the red flag customer list
5. WHEN confidence score is ≥85%, THE AI_Agent SHALL categorize as "ready_to_schedule"
6. WHEN confidence score is <85%, THE AI_Agent SHALL categorize as "needs_review"
7. WHEN categorizing seasonal services (startup, tuneup, winterization), THE AI_Agent SHALL auto-price at $45-65/zone based on zone count
8. WHEN categorizing small repairs, THE AI_Agent SHALL suggest pricing based on service catalog ($50/head, $100 diagnostic)
9. WHEN categorizing new installations or complex repairs, THE AI_Agent SHALL recommend site visit for estimate
10. WHEN a request mentions "large property" or vague descriptions, THE AI_Agent SHALL flag for human review
11. WHEN a request is from a partner source, THE AI_Agent SHALL apply partner pricing rules
12. THE System SHALL display categorization results grouped by: Ready to Schedule, Needs Estimate, Needs Review, Red Flag
13. THE System SHALL provide "Approve All Ready", "Review Individually", and "Bulk Actions" options
14. WHEN a user manually overrides categorization, THE System SHALL allow the override and log the change

### Requirement 6: Customer Communication Drafts

**User Story:** As a business owner, I want the AI to draft customer communications, so that I can reduce the time spent individually texting each customer while maintaining personalized service.

#### Acceptance Criteria

1. WHEN an appointment is scheduled, THE AI_Agent SHALL draft a confirmation message with date, time window, and reply instructions
2. WHEN an appointment is one day away, THE AI_Agent SHALL draft a reminder message with access instructions
3. WHEN a technician marks "en route", THE AI_Agent SHALL draft an "on the way" notification with ETA
4. WHEN a job is completed, THE AI_Agent SHALL draft a completion summary message
5. WHEN an invoice is 3 days past due, THE AI_Agent SHALL draft a friendly payment reminder
6. WHEN an invoice is 7+ days past due, THE AI_Agent SHALL draft a firmer follow-up with late fee warning
7. WHEN an estimate has no response for 1 week, THE AI_Agent SHALL draft a follow-up message
8. WHEN drafting messages, THE AI_Agent SHALL use placeholders for PII that are filled locally before display
9. WHEN a draft is generated, THE System SHALL display the message with "Send Now", "Edit", and "Schedule for Later" options
10. THE System SHALL NEVER send any message without explicit user approval (click to send)
11. THE System SHALL support bulk sending of similar messages (e.g., all confirmations) with single approval
12. WHEN a customer is on the "slow payer" list, THE AI_Agent SHALL add a note to payment reminders
13. THE System SHALL track message delivery status (sent, delivered, failed) via Twilio

### Requirement 7: Communications Queue Management

**User Story:** As a business owner, I want a centralized view of all pending and sent communications, so that I can manage customer messaging efficiently without visiting individual customer pages.

#### Acceptance Criteria

1. THE System SHALL display a Communications Queue panel on the Dashboard
2. WHEN displaying the queue, THE System SHALL group messages by: Pending, Scheduled, Sent Today, Failed
3. WHEN messages are pending, THE System SHALL provide "Send All" and "Review" bulk actions
4. WHEN messages are scheduled, THE System SHALL display scheduled send time and provide "Pause All" option
5. WHEN messages have been sent, THE System SHALL display timestamp, recipient, and delivery status
6. WHEN message delivery fails, THE System SHALL display error reason and provide "Retry" option
7. THE System SHALL prevent duplicate sends by tracking message history per customer per type
8. THE System SHALL store sent message records with customer_id, message_type, content, sent_at, delivery_status, and twilio_sid
9. THE System SHALL provide filtering by message type (confirmation, reminder, follow-up, payment)
10. THE System SHALL provide search by customer name or phone number

### Requirement 8: Natural Language Business Queries

**User Story:** As a business owner, I want to ask questions about my business in plain English, so that I can quickly get answers without navigating multiple screens or running reports.

#### Acceptance Criteria

1. THE System SHALL provide a chat interface on the Dashboard for natural language queries
2. WHEN a user asks about customers, THE AI_Agent SHALL query the customer database and return relevant results
3. WHEN a user asks about jobs, THE AI_Agent SHALL query the jobs database with appropriate filters
4. WHEN a user asks about revenue or finances, THE AI_Agent SHALL calculate totals from invoice/payment data
5. WHEN a user asks about staff schedules, THE AI_Agent SHALL query appointments and availability
6. WHEN a user asks about trends, THE AI_Agent SHALL compare current period to previous periods
7. WHEN returning results, THE AI_Agent SHALL format data clearly with counts, totals, and breakdowns by category
8. WHEN results suggest actions, THE AI_Agent SHALL offer relevant follow-up options (e.g., "Draft Reminder Campaign", "Show Full List", "Export CSV")
9. THE System SHALL maintain session history for context (max 50 messages, browser tab lifetime)
10. THE System SHALL provide a "Clear Chat" button to reset session
11. WHEN session reaches 50 messages, THE System SHALL drop oldest messages to maintain limit
12. THE System SHALL display example queries to help users understand capabilities

### Requirement 9: Smart Estimate Generation

**User Story:** As a business owner, I want the AI to generate estimates based on job details and similar completed jobs, so that I can provide accurate quotes quickly without manual calculation.

#### Acceptance Criteria

1. WHEN a job requires an estimate, THE AI_Agent SHALL analyze the job description for scope indicators
2. WHEN analyzing scope, THE AI_Agent SHALL estimate zone count based on lot size and property description
3. WHEN generating an estimate, THE AI_Agent SHALL reference similar completed jobs in the same area
4. WHEN generating an estimate, THE AI_Agent SHALL calculate pricing based on service catalog rates
5. WHEN generating an estimate, THE AI_Agent SHALL provide a breakdown (materials, labor, equipment, margin)
6. WHEN the job description is vague, THE AI_Agent SHALL recommend a site visit before final estimate
7. WHEN similar jobs exist, THE AI_Agent SHALL display them with addresses, zone counts, and final prices
8. THE System SHALL display the estimate with "Generate Estimate PDF", "Schedule Site Visit", and "Adjust Quote" options
9. WHEN a user adjusts the quote, THE System SHALL allow manual override of AI-calculated values
10. THE System SHALL NOT send estimates without explicit user approval
11. THE System SHALL track estimate status and auto-schedule follow-ups at 1 week, 2 weeks, and monthly

### Requirement 10: Morning Briefing Panel

**User Story:** As a business owner, I want a daily briefing summarizing overnight requests and today's priorities, so that I can start each day with a clear picture of what needs attention.

#### Acceptance Criteria

1. THE System SHALL display a Morning Briefing panel on the Dashboard
2. WHEN displaying the briefing, THE AI_Agent SHALL summarize overnight job requests with categorization counts
3. WHEN displaying the briefing, THE AI_Agent SHALL show today's schedule summary by staff member
4. WHEN displaying the briefing, THE AI_Agent SHALL highlight customers who haven't confirmed appointments
5. WHEN displaying the briefing, THE AI_Agent SHALL show pending communications count with quick actions
6. WHEN displaying the briefing, THE AI_Agent SHALL show outstanding invoice totals by aging bucket
7. THE System SHALL provide quick action links: "Review All Requests", "View Schedule", "Send Confirmations", "View Invoices"
8. THE System SHALL update the briefing in real-time as actions are taken
9. THE System SHALL personalize the greeting based on time of day ("Good morning, Viktor!")

### Requirement 11: Weather Integration

**User Story:** As a business owner, I want weather forecasts integrated into scheduling, so that I can avoid scheduling outdoor work during bad weather.

#### Acceptance Criteria

1. THE System SHALL integrate with OpenWeatherMap API for 5-day weather forecasts
2. WHEN generating schedules, THE AI_Agent SHALL fetch weather data for the Twin Cities area
3. WHEN precipitation probability exceeds 70%, THE System SHALL flag affected jobs as weather-sensitive
4. WHEN weather warnings exist, THE System SHALL display affected jobs with "Consider rescheduling" recommendation
5. THE System SHALL NOT auto-reschedule jobs; weather flags are advisory only requiring human decision
6. WHEN the weather API is unavailable, THE System SHALL display "Weather data unavailable" and allow scheduling without weather info
7. THE System SHALL run a daily cron job at 6am to update forecasts for the next 5 days
8. THE System SHALL provide a manual refresh button on the schedule page

### Requirement 12: SMS Infrastructure (Twilio Integration)

**User Story:** As a business owner, I want to send and receive SMS messages through the platform, so that AI-drafted communications can actually reach customers.

#### Acceptance Criteria

1. THE System SHALL integrate with Twilio for outbound SMS messaging
2. WHEN sending an SMS, THE System SHALL use the configured Twilio phone number as sender
3. WHEN sending an SMS, THE System SHALL format phone numbers in E.164 format (+1XXXXXXXXXX)
4. WHEN an SMS is sent, THE System SHALL store the Twilio message SID for tracking
5. THE System SHALL implement a webhook endpoint to receive incoming SMS replies
6. WHEN a customer replies "YES", THE System SHALL mark the appointment as confirmed
7. WHEN a customer replies "NO", "CANCEL", or "RESCHEDULE", THE System SHALL flag for manual review
8. THE System SHALL track SMS opt-in status per customer (sms_opt_in field)
9. THE System SHALL NOT send SMS to customers who have not opted in
10. WHEN SMS delivery fails, THE System SHALL log the failure and display in Communications Queue
11. THE System SHALL estimate monthly SMS costs (~$18-25/month for 150 jobs/week)

### Requirement 13: Session and Context Management

**User Story:** As a system administrator, I want proper session and context management, so that AI interactions are efficient and don't consume excessive resources.

#### Acceptance Criteria

1. THE System SHALL scope chat sessions to browser tab lifetime (no cross-session persistence)
2. THE System SHALL limit session history to 50 messages maximum
3. WHEN session limit is reached, THE System SHALL drop oldest messages while preserving recent context
4. THE System SHALL provide a visible "Clear Chat" button in the chat interface
5. WHEN building AI context, THE System SHALL prioritize: current request (500 tokens), business rules (100 tokens), customer info (300 tokens), recent job history (500 tokens)
6. WHEN context exceeds budget, THE System SHALL truncate in order: older job history, staff availability beyond 3 days, summarize customer info
7. THE System SHALL never truncate current request or business rules from context
8. THE System SHALL display session message count in the chat interface

### Requirement 14: Error Handling and Graceful Degradation

**User Story:** As a business owner, I want the system to handle AI failures gracefully, so that I can always complete my work even when AI features are unavailable.

#### Acceptance Criteria

1. WHEN the LLM API is down, THE System SHALL display "AI temporarily unavailable" banner
2. WHEN AI is unavailable, THE System SHALL enable all manual workflow buttons
3. WHEN the AI returns invalid output, THE System SHALL detect via schema validation and retry once
4. WHEN retry fails, THE System SHALL display "AI couldn't process this request" with manual fallback
5. WHEN rate limits are hit, THE System SHALL queue requests and show "Processing..." spinner
6. WHEN network timeout occurs, THE System SHALL retry with exponential backoff (1s, 2s, 4s) max 3 times
7. WHEN streaming is interrupted, THE System SHALL show partial response with "Response incomplete, try again"
8. THE System SHALL log all AI failures with error details for monitoring
9. THE System SHALL ensure AI features are enhancements, never blockers to manual workflows

### Requirement 15: API Endpoints

**User Story:** As a frontend developer, I want well-defined API endpoints for all AI features, so that I can build consistent and reliable user interfaces.

#### Acceptance Criteria

1. THE System SHALL provide POST /api/v1/ai/chat for general natural language queries with streaming support
2. THE System SHALL provide POST /api/v1/ai/schedule/generate for schedule generation with date range and staff filters
3. THE System SHALL provide POST /api/v1/ai/jobs/categorize for batch job categorization with confidence scores
4. THE System SHALL provide POST /api/v1/ai/communication/draft for generating communication drafts by type
5. THE System SHALL provide POST /api/v1/ai/estimate/generate for estimate generation with pricing breakdown
6. THE System SHALL provide GET /api/v1/ai/usage for retrieving current usage statistics
7. THE System SHALL provide GET /api/v1/ai/audit for querying audit logs with filters
8. THE System SHALL provide POST /api/v1/sms/send for sending SMS via Twilio
9. THE System SHALL provide POST /api/v1/sms/webhook for receiving incoming SMS
10. THE System SHALL provide GET /api/v1/communications/queue for retrieving the communications queue
11. THE System SHALL provide GET /api/v1/weather/forecast for retrieving weather data
12. All AI endpoints SHALL return consistent JSON response schemas with success flag and error details

### Requirement 16: Frontend Components

**User Story:** As a user, I want intuitive AI-powered UI components, so that I can easily interact with AI features throughout the application.

#### Acceptance Criteria

1. THE System SHALL provide an AIQueryChat component for the Dashboard natural language interface
2. THE System SHALL provide an AIScheduleGenerator component for the Schedule Generation page
3. THE System SHALL provide an AICategorization component for the Job Requests page
4. THE System SHALL provide an AICommunicationDrafts component for Customer and Job Detail pages
5. THE System SHALL provide an AIEstimateGenerator component for Job Detail pages
6. THE System SHALL provide a MorningBriefing component for the Dashboard
7. THE System SHALL provide a CommunicationsQueue component for the Dashboard
8. All AI components SHALL display loading states during AI processing
9. All AI components SHALL display error states with retry options
10. All AI components SHALL use streaming display for real-time AI output
11. All AI components SHALL include clear "Approve" and "Reject" action buttons

### Requirement 17: Data Validation and Security

**User Story:** As a system administrator, I want comprehensive data validation and security, so that the AI system maintains data integrity and protects sensitive information.

#### Acceptance Criteria

1. THE System SHALL validate all AI request inputs against Pydantic schemas
2. THE System SHALL sanitize all user input before including in AI prompts
3. THE System SHALL use structured tool calls instead of free-form instructions to prevent prompt injection
4. THE System SHALL validate AI outputs against expected response schemas
5. THE System SHALL never execute code from AI responses
6. THE System SHALL never send passwords, tokens, or API keys to LLM APIs
7. THE System SHALL mask PII in all log entries
8. THE System SHALL enforce HTTPS for all AI API communications
9. THE System SHALL validate Twilio webhook signatures to prevent spoofing
10. THE System SHALL rate limit webhook endpoints to prevent abuse

### Requirement 18: Testing Strategy

**User Story:** As a developer, I want comprehensive testing for AI features, so that I can ensure reliability and catch regressions.

#### Acceptance Criteria

1. THE System SHALL use mock LLM responses for unit tests (deterministic)
2. THE System SHALL use GPT-3.5-turbo for integration tests (cheaper, faster)
3. THE System SHALL maintain a golden dataset of 30 input/output pairs per AI capability
4. THE System SHALL run prompt regression tests on any prompt changes
5. THE System SHALL mock LLM for load testing infrastructure
6. THE System SHALL use anonymized/fake customer data in all tests
7. THE System SHALL achieve 80%+ code coverage for AI service layer
8. THE System SHALL achieve 70%+ code coverage for AI API endpoints
9. THE System SHALL include tests for rate limiting behavior
10. THE System SHALL include tests for graceful degradation scenarios

### Requirement 19: Agent Browser Visual Validation

**User Story:** As a developer, I want automated visual validation using agent-browser, so that I can verify all AI UI components render and function correctly.

#### Acceptance Criteria

1. WHEN implementing the AIQueryChat component, THE System SHALL validate rendering using agent-browser snapshot and interaction commands
2. WHEN implementing the AIScheduleGenerator component, THE System SHALL validate rendering using agent-browser snapshot and interaction commands
3. WHEN implementing the AICategorization component, THE System SHALL validate rendering using agent-browser snapshot and interaction commands
4. WHEN implementing the AICommunicationDrafts component, THE System SHALL validate rendering using agent-browser snapshot and interaction commands
5. WHEN implementing the AIEstimateGenerator component, THE System SHALL validate rendering using agent-browser snapshot and interaction commands
6. WHEN implementing the MorningBriefing component, THE System SHALL validate rendering using agent-browser snapshot and interaction commands
7. WHEN implementing the CommunicationsQueue component, THE System SHALL validate rendering using agent-browser snapshot and interaction commands
8. THE System SHALL include data-testid attributes on all AI components for agent-browser targeting
9. THE System SHALL validate that AI loading states display correctly using agent-browser
10. THE System SHALL validate that AI error states display correctly using agent-browser
11. THE System SHALL validate that AI streaming responses display correctly using agent-browser
12. THE System SHALL validate that approve/reject buttons are visible and clickable using agent-browser
13. THE System SHALL create validation scripts for each AI feature user journey
14. THE System SHALL run agent-browser validations as part of the task completion workflow
